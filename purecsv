#!/usr/bin/env bash
set +vx
# purecsv - Add users from pure.csv to PureFTPd's Virtual User database
# Usage: purecsv [-d|--delete | -p|--purge]
#        -d/--delete deletes all current users and starts afresh
#        -p/--purge also deletes all unused home directories
#    pure.csv: [#]<username>,<section>,<password>
#        Lines starting with # are ignored.
# Required: pureftp[github.com/jedisct1/pure-ftpd](pure-pw)

Err(){ # 1:msg
	echo "Error: $1"
	exit 1
}

Add(){ # 1:user 2:section 3:pw
	local dir="$2/$1"
	[[ ${2:0:1} = '*' ]] && dir=${2:1}
	echo -e "$3\n$3" |sudo pure-pw useradd $1 -u pureftp -d /home/pureftp/$dir &>/dev/null &&
		echo "User '$1' at '/home/pureftp/$dir' added to PureFTPd Virtual Users database"
}

passwd=/etc/pureftpd.passwd csv=pure.csv delete=0 purge=0
[[ $2 ]] &&
	Err "too many arguments, only -d|--delete | -p|--purge allowed"

[[ $1 ]] &&
	! [[ $1 = -d || $1 = --delete || $1 = -p || $1 = --purge ]] &&
	Err "wrong argument, only -d|--delete | -p|--purge allowed"

[[ $1 ]] &&
	delete=1
[[ $1 = -p || $1 = --purge ]] &&
	purge=1
[[ ! -f $csv ]] &&
	Err "csv-file '$csv' not found"

if ((delete))
then # Start with empty database
	sudo mv -f --backup=t "$passwd" "$passwd-backup"
	sudo touch "$passwd"
	echo "Database emptied, backup made"
else # Just backup and keep the current database
	sudo cp -f --backup=t "$passwd" "$passwd-backup"
	echo "Database backup made"
fi
ls -l "$passwd"-*

while IFS=, read -r -d $'\n' user section pw
do # Process line
	[[ -z $user ]] && Err "no username found in line"
	[[ -z $section ]] && Err "no section found in line"
	[[ -z $pw ]] && Err "no password found in line"
	[[ $user = *' '* ]] && Err "username cannot have spaces"
	[[ $section = *' '* ]] && Err "section cannot have spaces"
	[[ $pw = *' '* ]] && Err "password cannot have spaces"
	[[ ${user:0:1} = '#' ]] &&
		echo "Comment: $user,$secion,$pw" &&
		continue
	! Add $user $session $pw &&
		sudo pure-pw userdel $user &&
		echo "User '$user' deleted first" &&
		Add $user $section $pw
done <"$csv"

sudo pure-pw mkdb &&
	echo "Database changes committed, PureFTPd is now using them" ||
	Err "failure to commit changes to database"

if ((purge))
then # Purge if user with home dir not found in passwd
	shopt -s nullglob
	for dir in /home/pureftp/*/*
	do # For all virtual user directories
		_=${dir#/home/pureftp/} section=${_%/*} user=${section#*/}
		# Skip if not top directory
		[[ $user = */* ]] &&
			continue
		# If user under given section: skip it
		sudo grep -q "^$user," "$passwd" |grep -q ",$section," &&
			continue
		sudo rm -rf "$dir" &&
			echo "Directory '$dir' removed"
	done
	# If sections are empty, delete them altogether
	for dir in /home/pureftp/*
	do # Remove section directory if empty
		[[ ! ${dir#/home/pureftp/} = */* ]] &&
			sudo rmdir "$dir"
	done
fi
