#!/usr/bin/env bash
set +vx
# purecsv - Add users from pure.csv to PureFTPd's Virtual User database
# Usage: purecsv [-d|--delete | -p|--purge]
#        -d/--delete deletes all current users and starts afresh
#        -p/--purge also deletes all unused home directories
#    pure.csv: [#]<section>,[<username>],<password>
#        Lines starting with # are ignored.
#        Lines with no username take <section> as a username & home directory.
#        Never should any <section> also be a <username> under any section!
# Required: pureftp[github.com/jedisct1/pure-ftpd](pure-pw)

Err(){ # 1:msg
	echo "Error: $1"
	exit 1
}

Add(){ # 1:section 2:user 3:pw I:home
	local dir=$1 user=$1
	[[ $2 ]] &&
		dir=$1/$2 user=$2
	echo -e "$3\n$3" |sudo pure-pw useradd $user -u pureftp -d "$home/$dir" &>/dev/null &&
		echo "User '$user' at '$home/$dir' added to PureFTPd Virtual Users database" &&
		return
	# Adding didn't work, delete the existing user
	! sudo pure-pw userdel $user &&
		Err "cannot add or delete user '$user'"
	echo "User '$user' deleted first"
	Add $section "$user" $pw
}

passwd=/etc/pureftpd.passwd home=/home/pureftp csv=pure.csv delete=0 purge=0
[[ $2 ]] &&
	Err "too many arguments, only -d|--delete | -p|--purge allowed"

[[ $1 ]] &&
	! [[ $1 = -d || $1 = --delete || $1 = -p || $1 = --purge ]] &&
	Err "wrong argument, only -d|--delete | -p|--purge allowed"

[[ $1 ]] &&
	delete=1
[[ $1 = -p || $1 = --purge ]] &&
	purge=1
[[ ! -f $csv ]] &&
	Err "csv-file '$csv' not found"

if ((delete))
then # Start with empty database
	sudo mv -f --backup=t "$passwd" "$passwd-backup"
	sudo touch "$passwd"
	echo "Database emptied, backup made"
else # Just backup and keep the current database
	sudo cp -f --backup=t "$passwd" "$passwd-backup"
	echo "Database backup made"
fi
ls -l "$passwd"-*

while IFS=, read -r -d $'\n' section user pw
do # Process line
	[[ ${section:0:1} = '#' ]] &&
		echo "Comment: $section,$user,$pw" &&
		continue
	[[ -z $section ]] && Err "no section found in line"
	[[ $section = *' '* ]] && Err "section cannot have spaces"
	[[ $user = *' '* ]] && Err "username cannot have spaces"
	[[ -z $pw ]] && Err "no password found in line"
	[[ $pw = *' '* ]] && Err "password cannot have spaces"
	Add $section "$user" $pw
	sudo -u pureftp -g pureftp mkdir -p "$home/$section/$user"
done <"$csv"

sudo pure-pw mkdb &&
	echo "Database changes committed, PureFTPd is now using them" ||
	Err "failure to commit changes to database"

if ((purge))
then # Purge if user with home dir not found in passwd
	shopt -s nullglob
	for dir in $home/*/*
	do # For all virtual user directories
		_=${dir#$home/} section=${_%/*} user=${section#*/}
		# Skip if not top directory
		[[ $user = */* ]] &&
			continue
		# If user under given section: skip it
		sudo grep -q "^$user:.*:$dir/./:" "$passwd" &&
			continue
		sudo rm -rf "$dir" &&
			echo "User directory '$dir' removed"
	done
	# If sections are empty, delete them altogether
	for dir in $home/*
	do # Remove section directory if empty
		[[ ! ${dir#$home/} = */* ]] &&
			sudo rmdir "$dir" &&
			echo "Section directory '$dir' removed"
	done
fi
